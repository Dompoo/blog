# 테스트에서 애플리케이션 컨텍스트 캐싱

작성일: 2025년 7월 1일 오전 12:06
카테고리: Test

- 모든 테스트 클래스가 각자의 애플리케이션 컨텍스트를 사용한다면 너무 느릴 것이다. (스프링이 테스트 클래스 개수만큼 띄워져야 한다.)
- 따라서 스프링은 기본적으로 **동일한 설정을 가진 테스트 클래스들 간**에는 애플리케이션 컨텍스트를 공유한다.
- 여기서 **동일한 설정**이란 다음을 말한다.
    - 동일한 프로필
    - 동일한 구성 프로퍼티
    - 동일한 빈 (MockBean, SpyBean등에 의하여 달라지면 X)
    - 동일한 컨텍스트 리프레시 여부 (DirtiesContext 사용 여부)
- 다른 요소들은 테스트간에 보통 비슷할 것이지만, 차이가 날 수 있는 부분은 **동일한 빈**이다.
    - 같은 SpringBootTest여도 테스트 대상이 다르면 모킹처리가 달라질 수 있다.
    - 슬라이스 테스트 등에서 테스트 대상이 다르면 빈이 달라질 수 있다. (webmvc + UserController ↔ webmvc + ProductController)
- 고민 1 : 슬라이스 테스트의 테스트 대상을 각각 설정하지 말고, 모두로 설정한 후에 공유하는 것이 이득인가?
→ 이것은 맞는 것 같다. WebMvcTest로 예를 들면, webmvc 띄워지는게 더 시간이 오래걸리지 컨트롤러는 시간이 비슷할 것이다. 3+1+3+1 보다 3+1+1 을 노리자.
- 고민 2 : 그러면 슬라이스 테스트를 모두 SpringBootTest로 전환하는게 이득인가?
→ 이것은 아닌 것 같다.
    - 간단하게 생각해보면, 아래와 같기 때문에 전환하는 것이 이득이다.
        
        > SpringBootTest 100개
        = 컨텍스트 로딩 5초 + 테스트 0.1 * 100초
        = 15초
        
        SpringBootTest 10개 + WebMvcTest 50개 + DataJpaTest 40개
        = 컨텍스트 로딩 5초+3초+3초 + 테스트 0.1 * 100초
        = 21초
        > 
    - 하지만 슬라이스 테스트를 통해 애플리케이션 컨텍스트를 따로 사용하면 각 종류를 병렬로 실행할 수 있다.
        
        > SpringBootTest 100개
        = 컨텍스트 로딩 5초 + 테스트 0.1 * 100초
        = 15초
        
        SpringBootTest 10개 = 5초 + 0.1 * 10초 = 6초
        WebMvcTest 50개 = 3초 + 0.1 * 50초 = 8초
        DataJpaTest 40개 = 3초 + 0.1 * 40초 = 7초
        = 가장 늦게 끝나는 작업이 8초
        > 
    - 성능 비교를 해봐야겠지만, 각 슬라이스 테스트별로는 종류를 유지하는 것이 이득일 것 같다.
- **결론 : 일단 성능 테스트를 먼저 하라. 아마 각 테스트 종류(SpringBootTest, DataJpaTest, WebMvcTest등)안에서 환경을 통일한 경우에 가장 나을 것이다.**